@page "/login"
@rendermode InteractiveServer
@using PassManGUI.Services
@inject AuthService AuthService
@inject NavigationManager Navigation

@* 
    Authentication Page - User Sign In
    
    Status: ✅ Connected to API via AuthService
    
    TODO:
    1. Implement OAuth authentication
       - Google OAuth flow
       - GitHub OAuth flow
       - X OAuth flow
    
    2. Add "Remember me" functionality with PIN protection
       - Implement PIN feature (see AuthService TODO)
    
    3. Add "Forgot password" flow
       - Create forgot password page
       - Implement email verification
*@

<PageTitle>Login - PassMan</PageTitle>

<div class="login-container">
    <div class="login-card">
        <!-- Logo and Header -->
        <div class="login-logo">
            <img src="/logo.png" alt="PassMan Logo" width="80" height="80" />
        </div>

        <div class="login-header">
            <h1>Welcome back</h1>
            <p>Please enter your details to sign in.</p>
        </div>

        <!-- OAuth Buttons -->
        <div class="oauth-container">
            @* TODO: Wire up OAuth handlers - call HandleGoogleLogin(), HandleGitHubLogin(), HandleTwitterLogin() *@
            <button type="button" class="oauth-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M17.5 10C17.5 9.5 17.5 9 17.4 8.6H10V11.8H14.3C14.1 12.8 13.5 13.7 12.6 14.3V16.3H15.2C16.7 14.9 17.5 12.7 17.5 10Z" fill="#4285F4"/>
                    <path d="M10 18C12.4 18 14.4 17.2 15.2 16.3L12.6 14.3C11.9 14.8 10.9 15.1 10 15.1C7.7 15.1 5.8 13.7 5.1 11.8H2.4V13.9C3.5 16.1 6.5 18 10 18Z" fill="#34A853"/>
                    <path d="M5.1 11.8C4.9 11.3 4.8 10.7 4.8 10C4.8 9.3 4.9 8.7 5.1 8.2V6.1H2.4C1.8 7.3 1.5 8.6 1.5 10C1.5 11.4 1.8 12.7 2.4 13.9L5.1 11.8Z" fill="#FBBC05"/>
                    <path d="M10 4.9C11 4.9 11.9 5.3 12.6 5.9L14.9 3.6C13.4 2.2 11.4 1.5 10 1.5C6.5 1.5 3.5 3.4 2.4 5.6L5.1 7.7C5.8 5.8 7.7 4.9 10 4.9Z" fill="#EA4335"/>
                </svg>
            </button>
            <button type="button" class="oauth-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10 0C4.477 0 0 4.477 0 10c0 4.42 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0110 4.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C17.137 18.163 20 14.418 20 10c0-5.523-4.477-10-10-10z" fill="currentColor"/>
                </svg>
            </button>
            <button type="button" class="oauth-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M15.5 2h2.92l-6.38 7.29L19 18h-5.87l-4.6-6.01L3.44 18H.52l6.82-7.79L1 2h6.02l4.16 5.5L15.5 2zm-1.02 14.36h1.62L5.62 3.66H3.89l10.59 12.7z" fill="currentColor"/>
                </svg>
            </button>
        </div>

        <div class="divider">
            <span>OR</span>
        </div>

        <!-- Login Form -->
        <form class="auth-form" id="loginForm" @onsubmit="HandleLogin" @onsubmit:preventDefault="true">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 10.5a.75.75 0 110 1.5.75.75 0 010-1.5zm.75-7.25a.75.75 0 00-1.5 0v4a.75.75 0 001.5 0v-4z" fill="currentColor"/>
                    </svg>
                    @errorMessage
                </div>
            }
            
            <div class="form-group">
                <label for="email">E-Mail Address</label>
                <input type="email" id="email" @bind="email" placeholder="Enter your email..." required disabled="@isLoading" />
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <div class="password-input">
                    <input type="@(showPassword ? "text" : "password")" id="password" @bind="password" placeholder="••••••••••" required disabled="@isLoading" />
                    <button type="button" class="toggle-password" @onclick="TogglePasswordVisibility" aria-label="Toggle password visibility">
                        <svg class="eye-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" style="opacity: @(showPassword ? "0.5" : "1")">
                            <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6zm0 10a4 4 0 110-8 4 4 0 010 8zm0-6.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="form-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="remember" @bind="rememberMe" disabled="@isLoading" />
                    <span>Remember me</span>
                </label>
                <a href="#" class="link-text">Forgot password?</a>
            </div>

            <button type="submit" class="btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign in</span>
                }
            </button>
        </form>

        <!-- Sign Up Link -->
        <div class="signup-prompt">
            <span>Don't have an account yet? <a href="/signup" class="link-text-bold">Sign Up</a></span>
        </div>
    </div>
</div>

@code {
    private bool showPassword = false;
    private bool isLoading = false;
    private bool rememberMe = false;
    private string email = string.Empty;
    private string password = string.Empty;
    private string errorMessage = string.Empty;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        // Clear previous errors
        errorMessage = string.Empty;
        
        // Basic validation
        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "Please enter your email address.";
            return;
        }
        
        if (string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Please enter your password.";
            return;
        }
        
        try
        {
            isLoading = true;
            StateHasChanged();
            
            var result = await AuthService.LoginAsync(email, password);
            
            if (result.Success)
            {
                // Small delay to ensure sessionStorage is persisted
                await Task.Delay(100);
                
                // TODO: If rememberMe is true, implement PIN feature (see AuthService TODO)
                Navigation.NavigateTo("/vaults");
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Login failed. Please check your credentials.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during login. Please try again.";
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
